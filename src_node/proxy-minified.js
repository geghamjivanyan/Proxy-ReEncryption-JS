function Config(e){this._curve=e,this._default_curve=new Curve}function default_curve(){var e=new Config;return e.set_curve_by_default(),e.curve()}function Curve(e){e===void 0&&(e="secp256k1");var t=null;_supported_curves.includes(e)&&(t=secp256k1),this._curve=t,this._name=e,this._order=t.curve.n,this._generator=t.curve.g,this._order_size=t.curve.n.byteLength()}function to_hex(e){return Array.from(e,function(e){return("0"+(255&e).toString(16)).slice(-2)}).join("")}function from_hex(e){for(var t=[];e.length>=2;)t.push(parseInt(e.substring(0,2),16)),e=e.substring(2,e.length);return t}function SHA256(e){var t=hash.sha256().update(to_hex(e.to_bytes())).digest();return new Scalar(new BN(t))}function hash_to_scalar(e){for(var t=null,r=0;e.length>r;r++)t=hash.sha256().update(to_hex(e[r].to_bytes()));var n=t.digest();return new Scalar(new BN(n))}function Scalar(e,t){this._scalar=e,this._curve=t}function GroupElement(e,t){this._ec_point=e,this._curve=t}function PrivateKey(e,t){this._scalar=e,t===void 0&&(curve=new Curve,t=new PublicKey(new GroupElement(curve.generator().mul(e.valueOf())))),this._public_key=t}function PublicKey(e){this.pubKey=e}function ReEncryptionKey(e,t){this._re_key=e,this._internal_public_key=t}function KeyPair(e,t){this._private_key=e,this._public_key=t}function Capsule(e,t,r,n,u){u===void 0&&(u=!1),this._E=e,this._V=t,this._S=r,this._XG=n,this._re_encrypted=u}function Proxy(){}Config.prototype.set_curve_by_default=function(){this.set_curve(this._default_curve)},Config.prototype.set_curve=function(e){e===void 0&&(e=this._default_curve),this._curve=e},Config.prototype.curve=function(){return this._curve===void 0&&this.set_curve_by_default(),this._curve};var _supported_curves=["secp256k1"];Curve.prototype.name=function(){return this._name},Curve.prototype.order=function(){return this._order},Curve.prototype.generator=function(){return this._generator},Curve.prototype.order_size=function(){return this._order_size},Scalar.expected_byte_length=function(e){return e===void 0&&(e=default_curve()),e.order_size()},Scalar.generate_random=function(e){return e===void 0&&(e=default_curve()),new Scalar(e._curve.genKeyPair().getPrivate())},Scalar.prototype.curve=function(){return this._curve===void 0&&(this._curve=default_curve()),this._curve},Scalar.prototype.valueOf=function(){return this._scalar},Scalar.from_bytes=function(e){if(e.length!=Scalar.expected_byte_length()&&e.length!=2*Scalar.expected_byte_length())throw Error("Invalid length of data.");return new Scalar(new BN(e))},Scalar.prototype.to_bytes=function(){var e=this._scalar.toArray();return 33==e.length?e.slice(1,33):e},Scalar.prototype.add=function(e){return new Scalar(this.valueOf().add(e.valueOf()))},Scalar.prototype.sub=function(e){return new Scalar(this.valueOf().sub(e.valueOf()))},Scalar.prototype.mul=function(e){return new Scalar(this.valueOf().mul(e.valueOf()).mod(this.curve().order()))},Scalar.prototype.eq=function(e){return this.valueOf().eq(e.valueOf())},Scalar.prototype.invm=function(){return new Scalar(this.valueOf().invm(this.curve().order()))},GroupElement.expected_byte_length=function(e,t){return e===void 0&&(e=default_curve()),t?1+e.order_size():1+2*e.order_size()},GroupElement.generate_random=function(e){return e===void 0&&(e=default_curve()),new GroupElement(e.generator().mul(Scalar.generate_random().valueOf()))},GroupElement.from_bytes=function(e){var t=GroupElement.expected_byte_length();if(e.length!=t)throw Error("Invalid length of data.");var r=Scalar.expected_byte_length(),n=e.slice(1,r+1),u=e.slice(r+1,t);return new GroupElement(default_curve()._curve.curve.point(n,u))},GroupElement.prototype.to_bytes=function(){var e=this._ec_point.getX().toArray(),t=this._ec_point.getY().toArray();return[4].concat(e,t)},GroupElement.prototype.valueOf=function(){return this._ec_point},GroupElement.prototype.add=function(e){return new GroupElement(this.valueOf().add(e.valueOf()))},GroupElement.prototype.mul=function(e){return new GroupElement(this.valueOf().mul(e.valueOf()))},GroupElement.prototype.eq=function(e){return this.valueOf().eq(e.valueOf())},PrivateKey.genPrivKey=function(e,t,r){for(var n=new HmacDRBG({hash:t._curve.hash,pers:r.pers,persEnc:r.persEnc||"utf8",entropy:r.entropy||elliptic.rand(t._curve.hash.hmacStrength),entropyEnc:r.entropy&&r.entropyEnc||"utf8",nonce:t._curve.n.toArray()}),u=t._curve.n.byteLength(),o=t._curve.n.sub(new BN(2));;){var i=new BN(n.generate(u,e));if(!(i.cmp(o)>0))return i.iaddn(1),console.log("PRIV - ",i),t._curve.keyFromPrivate(i)}},PrivateKey.generate=function(e,t,r){t===void 0&&(t=default_curve()),e!==void 0&&(e=e.toString("hex")),r||(r={});var n=PrivateKey.genPrivKey(e,t,r);console.log("PRIV  - ",n);var u=t._curve.genKeyPair(e);return console.log("KP SK - ",u.getPrivate()),new PrivateKey(new Scalar(u.getPrivate()),new PublicKey(new GroupElement(u.getPublic())))},PrivateKey.prototype.valueOf=function(){return this._scalar},PrivateKey.prototype.get_public_key=function(){return curve=new Curve,new PublicKey(new GroupElement(curve.generator().mul(this.valueOf().valueOf())))},PrivateKey.from_bytes=function(e){return new PrivateKey(Scalar.from_bytes(e))},PrivateKey.prototype.to_bytes=function(){return this.valueOf().to_bytes()},PublicKey.prototype.valueOf=function(){return this.pubKey},PublicKey.from_bytes=function(e){return new PublicKey(GroupElement.from_bytes(e))},PublicKey.prototype.to_bytes=function(){return this.valueOf().to_bytes()},ReEncryptionKey.prototype.get_re_key=function(){return this._re_key},ReEncryptionKey.prototype.get_internal_public_key=function(){return this._internal_public_key},ReEncryptionKey.from_bytes=function(e){var t=Scalar.expected_byte_length(),r=GroupElement.expected_byte_length();if(e.length!=r+t)throw Error("Invalid length of data.");var n=Scalar.from_bytes(e.slice(0,t)),u=GroupElement.from_bytes(e.slice(t,t+r));return new ReEncryptionKey(n,u)},ReEncryptionKey.prototype.to_bytes=function(){var e=this.get_re_key().to_bytes(),t=this.get_internal_public_key().to_bytes();return e.concat(t)},KeyPair.generate_key_pair=function(e){var t=PrivateKey.generate(e);return new KeyPair(t,t.get_public_key())},KeyPair.prototype.get_public_key=function(){return this._public_key},KeyPair.prototype.get_private_key=function(){return this._private_key},Capsule.prototype.get_E=function(){return this._E},Capsule.prototype.get_V=function(){return this._V},Capsule.prototype.get_S=function(){return this._S},Capsule.prototype.get_XG=function(){return this._XG},Capsule.prototype.set_re_encrypted=function(){this._re_encrypted=!0},Capsule.prototype.is_re_encrypted=function(){return this._re_encrypted},Capsule.from_bytes=function(e){var t=Scalar.expected_byte_length(),r=GroupElement.expected_byte_length(),n=!1;if(e.length==3*r+t)n=!0;else if(e.length!=2*r+t)throw Error("Invalid length of data.");var u=GroupElement.from_bytes(e.slice(0,r)),o=GroupElement.from_bytes(e.slice(r,2*r)),i=Scalar.from_bytes(e.slice(2*r,2*r+t)),a=void 0;return n&&(a=GroupElement.from_bytes(e.slice(2*r+t,3*r+t))),new Capsule(u,o,i,a,n)},Capsule.prototype.to_bytes=function(){var e=this.get_E().to_bytes(),t=this.get_V().to_bytes(),r=this.get_S().to_bytes(),n=[];return this.is_re_encrypted()&&(n=this.get_XG().to_bytes()),e.concat(t,r,n)},Proxy.generate_key_pair=function(e){return KeyPair.generate_key_pair(e)},Proxy.encapsulate=function(e){var t=Proxy.generate_key_pair(),r=Proxy.generate_key_pair(),n=t.get_private_key().valueOf(),u=r.get_private_key().valueOf(),o=t.get_public_key().valueOf(),i=r.get_public_key().valueOf(),a=[o,i],_=hash_to_scalar(a),c=n.add(u.mul(_)),l=e.valueOf(),y=l.mul(n.add(u)),p=SHA256(y),s=new Capsule(o,i,c),f={capsule:s,symmetric_key:p};return f},Proxy.decapsulate_original=function(e,t){var r=t.valueOf(),n=e.get_E().add(e.get_V()),u=n.mul(r),o=SHA256(u);return o},Proxy.generate_re_encryption_key=function(e,t){var r=Proxy.generate_key_pair(),n=r.get_private_key().valueOf(),u=r.get_public_key().valueOf(),o=t.valueOf(),i=[u,o,o.mul(n)],a=hash_to_scalar(i),_=e.valueOf(),c=a.invm(),l=_.mul(c),y=new ReEncryptionKey(l,u);return y},Proxy.re_encrypt_capsule=function(e,t){var r=e.get_E().mul(t.get_re_key()),n=e.get_V().mul(t.get_re_key()),u=e.get_S();return new Capsule(r,n,u,t.get_internal_public_key(),!0)},Proxy.decapsulate_re_encrypted=function(e,t){var r=e.get_XG(),n=e.get_E(),u=e.get_V(),o=[r,t.get_public_key().valueOf(),r.mul(t.valueOf())],i=hash_to_scalar(o),a=n.add(u).mul(i),_=SHA256(a);return _},Proxy.decapsulate=function(e,t){return e.is_re_encrypted()?Proxy.decapsulate_re_encrypted(e,t):Proxy.decapsulate_original(e,t)},Proxy.private_key_from_bytes=function(e){return PrivateKey.from_bytes(e)},Proxy.public_key_from_bytes=function(e){return PublicKey.from_bytes(e)},Proxy.re_encryption_key_from_bytes=function(e){return ReEncryptionKey.from_bytes(e)},Proxy.capsule_from_bytes=function(e){return Capsule.from_bytes(e)};

const BN = require('bn.js');
const EC = require('elliptic').ec;
const hash = require('hash.js');
const HmacDRBG = require('hmac-drbg');
const elliptic = require('elliptic');
const rand = elliptic.rand;
const secp256k1 = new EC('secp256k1');

exports.Scalar=Scalar;
exports.GroupElement=GroupElement;
exports.PrivateKey=PrivateKey;
exports.PublicKey=PublicKey;
exports.ReEncryptionKey=ReEncryptionKey;
exports.KeyPair=KeyPair;
exports.Proxy=Proxy;
exports.Capsule=Capsule;
